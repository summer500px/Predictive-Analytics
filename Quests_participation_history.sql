# This is an example which only applies to Quest#103
WITH u AS
  (SELECT user_id
   FROM quest_events
   WHERE quest_id =  123
   GROUP BY user_id),

p AS
  (SELECT user_id, followers, # user popularity: number of followers
  	(case when about ilike '%insta%' then 'yes' else 'no' end) insta, # user profile bio: whether including instagram
  	(case when about ilike '%@%' then 'yes' else 'no' end) at_symbol  # user profile bio: whether including @
FROM u left join users on u.user_id = users.id),

q_base AS
(select u.user_id, count(distinct quest_id) repetitive_submits # number of unique quests a photo has been submitted to
 from quest_events inner join u on quest_events.user_id = u.user_id
 where quest_id < 123
 group by photo_id, u.user_id),

q AS (
 select user_id, sum(repetitive_submits) - 1 as rep_submits
 from q_base
 where repetitive_submits > 1
 group by user_id),
 
# users who have ever made to second round (shortlisted)
white_list AS (
select user_id
from quest_events
where photo_id in
(642468,2929942,37041864,38568598,41996876,49159440,55450630,55526312,58606646,61494663,64894785,66901435,68776317,70816845,71995589,72243537,72249171,72315099,72330261,72947133,73994831,74753925,74782937,75904561,76064431,76517551,76814281,77233783,77257187,78389767,78951701,79443705,85581065,85783663,86532193,89002799,89518597,89518871,89519473,90928039,91072335,92156623,92365775,92813119,93026771,93268185,94599617,95374819,95657905,96516181,97219751,100086309,101156607,101822043,102791581,103321055,104905545,105654127,105669977,106353149,106664871,107633291,107823365,107946029,108226167,108302861,110234783,110533221,111275847,111292181,111462199,112314459,112695175,113497345,113580929,113608087,113644917,113755333,113763639,114880365,115940139,116173843,116248829,118845049,119564935,119623755,119623757,120994463,121105713,121288507,123534369,123601313,123839609,124551461,125072911,125215553,125622961,125939839,127677135,127791771,128326873,128337071,128359023,128359723,128479721,128682055,128685111,131245721,131324387,131413887,131519859,132343581,132987991,133006509,133034173,133203487,133432789,133872643,134537207,135464565,137414749,137503085,137757819,137777895,137836493,138027617,138794681,138833247,138966495,138988213,139185709,139204525,139503765,140352031,140493645,140972281,140996407,141077065,141085925,141616887,141690731,141869257,142089803,142248165,142281601,142359997,142404935,142471571,142843989,142977175,143241415,144197641,144406719,145258215,145282391,145468277,145470397,145549639,145571843,145798313,146925383,147204621,147213089,147444839,147457809,147518149,147664993,147685457,148212187,148555703,148819345,148824459,149083663,149219443,149230021,149493363,149646981,149656029,149668983,149915633,150020829,150255275,150255853,150532353,150550765,150829061,150840805,150859983,150871403,150876955,150947747,150984605,151006933,151015147,151041783,151049499,151107787,151180703,151213047,151307625,151312943,151315733,151330049,151400027,151423753,151423755,151423775,151425057,151620859,151679167,151720545,151891797,151983291,151996769,152137895,152164839,152247747,152300195,152364409,152377299,152402311,152558731,152580883,152727745,152815935,152900341,152934803,152985679,153027719,153034389,153096327,153277807,153313183,153357205,153435773,153441911,153457677,153514611,153553917,153979933,154028419,154062167,154397139,154438369,154475153,154545293,154633219,154676365,154738539,154748067,154811343,154818219,154857033,154985321,155057907,155106233,155122355,155125727,155180537,155439687,155452121,155632645,155662789,155718257,155719963,155725113,155725883,155754227,155767191,155824849,155849603,155886793,156008119,156093209,156136307,156268363,156317067,156336153,156364151,156368021,156383735,156515455,156525765,156595875,156615679,156663293,156730093,156770137,156771953,156772323,156772821,156822083,156822131,156822181,156834917,156868061,156915657,156975045,157015789,157048937,157119707,157165095,157177937,157194191,157194229,157202061,157205881,157209299,157218159,157239569,157247139,157263731,157289073,157289087,157354353,157380013,157392339,157426747,157432243,157456187,157488251,157489693,157490735,157511737,157518037,157538763,157633881,157659629,157675507,157710905,157720661,157835729,157851103,157866217,157868189,157925663,157940871,157970711,157987083,158015907,158027817,158038923,158042347,158054345,158095159,158097115,158111619,158116151,158143553,158163409,158202425,158289719,158321741,158406837,158415773,158434555,158440089,158443183,158447683,158450259,158457865,158475035,158492717,158499547,158521593,158521831,158522063,158532185,158532187,158532189,158532191,158551447,158572157,158575881,158581617,158590285,158615939,158625741,158626191,158631121,158631903,158660885,158740617,158741285,158751163,158751173,158751175,158751867,158751963,158752141,158767049,158773169,158800373,158803491,158808449,158847783,158851051,158856491,158882481,158891603,158891875,158901711,158905837,158909069,158925553,158925605,158928675,158935641,158941473,158952651,158962169,158963549,159190709,159241807,159260313,159290685,159377811,159456059,159465563,159475917,159486841,159526535,159549275,159553471,159588967,159622783,159645797,159686743,159687667,159687793,159700513,159707815,159721679,159736749,159884255,159901267,159940743,159944395,159944397,159957569,159979773,160062459,160122345,160183693,160245827,160313643,160415297,160440689,160538147,160558127,160786433,160798317,160831019,160952581,160963091,160995033,161021773,161032631,161040387,161101013,161165495,161417045,161605143,161607313,161635075,161701039,161728847,165447729)
# the above photo ids are the shortlisted photos before Quest 103
group by user_id
)

select p.user_id, coalesce(p.followers,0) as num_followers, p.insta, p.at_symbol, coalesce(rep_submits,0) rep_submissions, (case when white_list.user_id is null then 'no' else 'yes' end) white_list
from p 
left join q on p.user_id = q.user_id
left join white_list on p.user_id = white_list.user_id and q.user_id = white_list.user_id